# E2 Bridge Configuration for ns-3 UAV Simulation
# This configuration template defines the E2 interface settings for connecting
# ns-3 simulation to O-RAN Near-RT RIC

---
# =============================================================================
# E2 Termination Configuration
# =============================================================================
e2_termination:
  # E2 node identification
  node:
    # Global E2 node type: gNB, eNB, ng-eNB, en-gNB
    type: "eNB"
    # PLMN Identity (3 bytes: MCC + MNC)
    # Format: "MCCMNC" where MCC=001, MNC=01 -> "111" (padded)
    plmn_id: "111"
    # Node ID (varies by type)
    # For eNB: 3 bytes (macro eNB ID)
    # For gNB: 4 bytes (gNB ID)
    node_id_prefix: "gnb"

  # E2 Node instances (one per eNB in simulation)
  instances:
    - id: 1
      name: "eNB-1"
      gnb_id: "gnb1"
      client_port: 38471
      cell_id: 1
      position:
        x: 200.0
        y: 200.0
        z: 30.0

    - id: 2
      name: "eNB-2"
      gnb_id: "gnb2"
      client_port: 38472
      cell_id: 2
      position:
        x: 500.0
        y: 500.0
        z: 30.0

    - id: 3
      name: "eNB-3"
      gnb_id: "gnb3"
      client_port: 38473
      cell_id: 3
      position:
        x: 800.0
        y: 200.0
        z: 30.0

# =============================================================================
# RIC Connection Configuration
# =============================================================================
ric:
  # Near-RT RIC address
  address: "10.0.2.10"
  # E2AP SCTP port (standard: 36422)
  port: 36422

  # Connection parameters
  connection:
    # SCTP parameters
    sctp:
      # Initial retransmission timeout (ms)
      rto_initial: 3000
      # Maximum retransmission timeout (ms)
      rto_max: 10000
      # Minimum retransmission timeout (ms)
      rto_min: 1000
      # Maximum association retransmissions
      max_init_retransmits: 8
      # Maximum path retransmissions
      max_path_retransmits: 5
      # Heartbeat interval (ms)
      heartbeat_interval: 30000

    # E2 setup parameters
    e2_setup:
      # Timeout for E2 Setup Response (ms)
      timeout: 10000
      # Maximum E2 setup retries
      max_retries: 3
      # Retry interval (ms)
      retry_interval: 5000

  # RIC platform configuration (OSC RIC)
  platform:
    type: "osc"
    version: "e-release"
    # RIC services endpoints (for reference)
    services:
      e2mgr: "http://service-ricplt-e2mgr-http:3800"
      submgr: "http://service-ricplt-submgr-http:3800"
      rtmgr: "http://service-ricplt-rtmgr-http:3800"
      a1mediator: "http://service-ricplt-a1mediator-http:10000"

# =============================================================================
# RAN Function Configuration
# =============================================================================
ran_functions:
  # KPM Service Model (E2SM-KPM)
  kpm:
    # RAN Function ID
    function_id: 2
    # OID for E2SM-KPM v2.0
    oid: "1.3.6.1.4.1.53148.1.2.2.2"
    # Description
    description: "KPM Service Model for UAV Metrics"

    # Supported measurement types
    measurements:
      # Standard LTE/NR measurements
      - name: "DRB.UEThpDl"
        type: "real"
        unit: "kbps"
        description: "DRB DL UE throughput"

      - name: "DRB.UEThpUl"
        type: "real"
        unit: "kbps"
        description: "DRB UL UE throughput"

      - name: "RRU.PrbUsedDl"
        type: "integer"
        unit: "PRBs"
        description: "DL PRBs used"

      - name: "RRU.PrbUsedUl"
        type: "integer"
        unit: "PRBs"
        description: "UL PRBs used"

      - name: "RRU.PrbAvailDl"
        type: "integer"
        unit: "PRBs"
        description: "DL PRBs available"

      - name: "RRU.PrbAvailUl"
        type: "integer"
        unit: "PRBs"
        description: "UL PRBs available"

      # UAV-specific measurements (custom)
      - name: "UAV.RSRP.Serving"
        type: "real"
        unit: "dBm"
        description: "RSRP of serving cell"

      - name: "UAV.RSRP.BestNeighbor"
        type: "real"
        unit: "dBm"
        description: "RSRP of best neighbor cell"

      - name: "UAV.SINR"
        type: "real"
        unit: "dB"
        description: "Signal to Interference Noise Ratio"

      - name: "UAV.Position.X"
        type: "real"
        unit: "meters"
        description: "UAV X position"

      - name: "UAV.Position.Y"
        type: "real"
        unit: "meters"
        description: "UAV Y position"

      - name: "UAV.Position.Z"
        type: "real"
        unit: "meters"
        description: "UAV altitude"

      - name: "UAV.Velocity"
        type: "real"
        unit: "m/s"
        description: "UAV horizontal velocity"

      - name: "UAV.PathProgress"
        type: "real"
        unit: "ratio"
        description: "Flight path completion ratio (0-1)"

    # Reporting styles
    report_styles:
      - id: 1
        name: "Periodic"
        description: "Periodic reporting"
        format: 1

      - id: 2
        name: "Event-Triggered"
        description: "Event triggered reporting"
        format: 1

  # RC Service Model (E2SM-RC)
  rc:
    # RAN Function ID
    function_id: 3
    # OID for E2SM-RC v1.0
    oid: "1.3.6.1.4.1.53148.1.1.2.3"
    # Description
    description: "RAN Control Service Model for UAV Control"

    # Supported control styles
    control_styles:
      - id: 1
        name: "Traffic Steering"
        description: "Handover control"
        request_id: 1001

      - id: 2
        name: "QoS Control"
        description: "PRB allocation and QoS"
        request_id: 1002

    # Supported control actions
    control_actions:
      - id: 1
        name: "Handover"
        description: "Trigger inter-cell handover"
        parameters:
          - name: "Target-Cell-ID"
            type: "octet_string"
            description: "Target cell CGI"

          - name: "UE-ID"
            type: "octet_string"
            description: "UE identifier (IMSI)"

      - id: 2
        name: "PRB-Allocation"
        description: "Adjust PRB allocation"
        parameters:
          - name: "PRB-Quota"
            type: "integer"
            min: 1
            max: 100
            description: "PRB quota for UE"

          - name: "Direction"
            type: "enum"
            values: ["DL", "UL", "Both"]
            description: "Traffic direction"

      - id: 3
        name: "Slice-Assignment"
        description: "Change network slice"
        parameters:
          - name: "S-NSSAI"
            type: "octet_string"
            description: "Network slice identifier"

# =============================================================================
# xApp Subscription Configuration
# =============================================================================
subscriptions:
  # KPM subscription for UAV monitoring
  uav_kpm:
    enabled: true
    function_id: 2
    event_trigger:
      # Reporting period in milliseconds
      reporting_period_ms: 500
      # Event trigger format
      format: 1

    # Action definitions
    actions:
      - action_id: 1
        action_type: "report"
        # Report definition
        definition:
          # Cells to monitor (empty = all)
          cells: []
          # UEs to monitor (empty = all)
          ues: []
          # Measurements to include
          measurements:
            - "UAV.RSRP.Serving"
            - "UAV.RSRP.BestNeighbor"
            - "UAV.SINR"
            - "UAV.Position.X"
            - "UAV.Position.Y"
            - "UAV.Position.Z"
            - "RRU.PrbUsedDl"
            - "RRU.PrbAvailDl"

  # RC subscription for UAV control
  uav_rc:
    enabled: true
    function_id: 3
    # Control styles enabled
    control_styles:
      - 1  # Traffic Steering
      - 2  # QoS Control

# =============================================================================
# HTTP Bridge Configuration (for hybrid operation)
# =============================================================================
http_bridge:
  # Enable HTTP-to-E2 bridge for backward compatibility
  enabled: true

  # HTTP server settings
  server:
    host: "0.0.0.0"
    port: 5000

  # Endpoint mappings (HTTP -> E2)
  endpoints:
    # KPM indication endpoint
    - http_path: "/e2/indication"
      http_method: "POST"
      e2_message: "RIC_INDICATION"
      function_id: 2

    # Alternative KPM endpoint
    - http_path: "/api/v1/kpm/indication"
      http_method: "POST"
      e2_message: "RIC_INDICATION"
      function_id: 2

  # Field mappings (HTTP JSON -> E2SM)
  field_mappings:
    indication:
      # Input JSON field -> E2SM-KPM field
      "uav_id": "ue_id"
      "position.x": "UAV.Position.X"
      "position.y": "UAV.Position.Y"
      "position.z": "UAV.Position.Z"
      "radio_snapshot.serving_cell_id": "cell_object_id"
      "radio_snapshot.rsrp_serving": "UAV.RSRP.Serving"
      "radio_snapshot.rsrp_best_neighbor": "UAV.RSRP.BestNeighbor"
      "radio_snapshot.prb_utilization_serving": "RRU.PrbUsedDl"
      "slice_id": "s_nssai"
      "path_position": "UAV.PathProgress"

    control:
      # E2SM-RC field -> Output JSON field
      "target_cell_id": "target_cell_id"
      "prb_quota": "prb_quota"
      "action_type": "action"

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  # Log level: DEBUG, INFO, WARNING, ERROR
  level: "INFO"

  # E2AP message logging
  e2ap:
    # Log encoded/decoded messages
    enabled: true
    # Log raw bytes (hex dump)
    raw_bytes: false
    # Log decoded ASN.1 structure (XER format)
    asn1_xer: true

  # Performance metrics logging
  metrics:
    enabled: true
    # Metrics log file
    file: "./logs/e2_metrics.log"
    # Log interval (seconds)
    interval: 10

# =============================================================================
# Simulation Integration
# =============================================================================
simulation:
  # ns-3 simulation parameters
  ns3:
    # Path to ns-3 build directory
    build_dir: "/opt/ns-oran/build"
    # Example scenario to run
    example: "contrib/oran/examples/uav-lte-xapp-example"

    # Simulation parameters
    params:
      # Simulation time (seconds)
      sim_time: 100
      # Measurement interval (seconds)
      interval: 0.5
      # Output file path
      output: "/tmp/ns3-uav-metrics.csv"
      # Enable E2 interface
      e2_enabled: true

  # Real-time synchronization
  realtime:
    # Enable real-time mode
    enabled: false
    # Sync ratio (sim time / wall time)
    ratio: 1.0

# =============================================================================
# Environment Variables (for containerized deployment)
# =============================================================================
environment:
  # RIC connection (override via environment)
  RIC_ADDRESS: "${RIC_ADDRESS:-10.0.2.10}"
  RIC_PORT: "${RIC_PORT:-36422}"

  # xApp identification
  XAPP_NAME: "${XAPP_NAME:-uav-policy-xapp}"
  XAPP_VERSION: "${XAPP_VERSION:-1.0.0}"

  # Logging
  LOG_LEVEL: "${LOG_LEVEL:-INFO}"

# =============================================================================
# Deployment Profiles
# =============================================================================
profiles:
  # Development profile (local testing)
  development:
    ric:
      address: "127.0.0.1"
      port: 36422
    http_bridge:
      enabled: true
    logging:
      level: "DEBUG"
      e2ap:
        asn1_xer: true

  # Integration testing profile
  integration:
    ric:
      address: "10.0.2.10"
      port: 36422
    http_bridge:
      enabled: true
    logging:
      level: "INFO"

  # Production profile
  production:
    ric:
      address: "${RIC_ADDRESS}"
      port: 36422
    http_bridge:
      enabled: false
    logging:
      level: "WARNING"
      e2ap:
        asn1_xer: false
